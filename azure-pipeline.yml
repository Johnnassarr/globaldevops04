# =============================================================================
# Azure DevOps Pipeline - EcoTask API
# =============================================================================
# Pipeline de CI/CD - Build, Test, Push para ACR e Deploy
# RM: 556221
# =============================================================================

trigger:
  branches:
    include:
    - main
    - master
  paths:
    exclude:
    - README.md
    - '*.md'
    - '*.sh'

pr:
  branches:
    include:
    - main
    - master

variables:
  # Build variables
  mavenVersion: '3.9.x'
  jdkVersion: '21'
  
  # Azure Service Connection (IMPORTANTE: Configure este valor no Azure DevOps!)
  # Substitua 'Azure-Service-Connection' pelo nome da sua Service Connection
  azureServiceConnection: 'Azure-Service-Connection'
  
  # Azure variables
  azureRG: 'rg-ecotask-rm556221'
  acrName: 'acrecotaskrm556221'
  acrLoginServer: 'acrecotaskrm556221.azurecr.io'
  location: 'eastus'
  
  # Image variables
  imageName: 'ecotask-api'
  imageTag: '$(Build.BuildId)'
  
  # Database variables (Configure no Azure DevOps como SECRET)
  # dbHost: '<configured-as-variable>'
  # dbPort: '5432'
  # dbName: 'ecotask'
  # dbUser: 'postgres'
  # dbPassword: '<configured-as-secret>'

stages:
# =============================================================================
# STAGE 1: BUILD & TEST (CI)
# =============================================================================
- stage: Build
  displayName: 'Build, Test and Push to ACR'
  jobs:
  - job: BuildJob
    displayName: 'Build Application'
    # NOTA: Usando self-hosted para evitar erro de paralelismo
    # Se você tem paralelismo habilitado, pode mudar para: vmImage: 'ubuntu-latest'
    pool:
      name: 'self-hosted-pool'
    # Alternativa se não tiver self-hosted (requer paralelismo):
    # pool:
    #   vmImage: 'ubuntu-latest'
    
    steps:
    # Checkout code
    - checkout: self
      displayName: 'Checkout Repository'
      clean: true
    
    # Instalar Java 21 se não estiver instalado
    - task: Bash@3
      displayName: 'Instalar/Verificar Java 21'
      inputs:
        targetType: 'inline'
        script: |
          echo "Verificando Java..."
          
          if command -v java &> /dev/null; then
            JAVA_VERSION=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | sed '/^1\./s///' | cut -d'.' -f1)
            echo "Java encontrado: versão $JAVA_VERSION"
            
            if [ "$JAVA_VERSION" -lt "21" ]; then
              echo "Java 21 é necessário. Instalando..."
              sudo apt update
              sudo apt install -y openjdk-21-jdk
            fi
          else
            echo "Java não encontrado. Instalando OpenJDK 21..."
            sudo apt update
            sudo apt install -y openjdk-21-jdk
          fi
          
          echo "Java instalado:"
          java -version
          
          # Configurar JAVA_HOME
          export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
          echo "JAVA_HOME set to: $JAVA_HOME"
          echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
    
    # Build with Maven Wrapper
    - task: Bash@3
      displayName: 'Maven: Clean and Build'
      inputs:
        targetType: 'inline'
        script: |
          echo "Building with Maven Wrapper..."
          echo "Working directory: $(pwd)"
          
          # Configurar HOME e JAVA_HOME
          if [ -z "$HOME" ]; then
            export HOME=/root
          fi
          
          if [ -z "$JAVA_HOME" ]; then
            export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
          fi
          
          echo "JAVA_HOME: $JAVA_HOME"
          
          # Dar permissão ao Maven Wrapper
          chmod +x mvnw
          
          # Build com Maven Wrapper (executa testes)
          ./mvnw clean package -DskipTests=false
          
          echo ""
          echo "Build completed!"
          echo "Artifact location: target/"
          
          # Verificar se o build gerou o JAR
          if [ -d "target" ]; then
            echo "Directory target/ exists"
            ls -lah target/*.jar 2>/dev/null || echo "No JAR files found"
          else
            echo "ERROR: Directory target/ was not created!"
            exit 1
          fi
    
    # Publish test results
    - task: PublishTestResults@2
      displayName: 'Publish Test Results (JUnit)'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        mergeTestResults: true
        failTaskOnFailedTests: false
        testRunTitle: 'Unit Tests - EcoTask'
    
    # Publish build artifact
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifact'
      condition: succeeded()
      continueOnError: true
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
        ArtifactName: 'target'
        publishLocation: 'Container'
    
    # Docker: Build Image
    - task: Docker@2
      displayName: 'Docker: Build Image'
      inputs:
        command: 'build'
        repository: '$(imageName)'
        dockerfile: 'dockerfiles/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        tags: |
          $(imageTag)
          latest
    
    # ACR: Login (Opcional - apenas se ACR estiver configurado)
    - task: Bash@3
      displayName: 'ACR: Docker Login (Opcional)'
      continueOnError: true
      name: ACRLogin
      inputs:
        targetType: 'inline'
        script: |
          echo "Verificando se ACR está configurado..."
          
          # Inicializar variável como false
          echo "##vso[task.setvariable variable=ACR_LOGIN_SUCCESS;isOutput=true]false"
          
          if [ -z "$ACR_PASSWORD" ] || [ -z "$(acrLoginServer)" ]; then
            echo "AVISO: ACR não configurado. Pulando login e push para ACR."
            echo "Para habilitar: Configure as variáveis acrPassword e acrLoginServer no Azure DevOps"
            echo "##vso[task.setvariable variable=ACR_LOGIN_SUCCESS;isOutput=true]false"
            exit 0
          fi
          
          echo "Fazendo login no ACR: $(acrLoginServer)"
          echo "Username: $(acrName)"
          
          # Tentar fazer login
          if echo "$ACR_PASSWORD" | docker login $(acrLoginServer) --username $(acrName) --password-stdin 2>&1; then
            echo "Login realizado com sucesso no ACR!"
            echo "##vso[task.setvariable variable=ACR_LOGIN_SUCCESS;isOutput=true]true"
          else
            echo "AVISO: Falha ao fazer login no ACR. ACR pode não existir ainda."
            echo "Pulando push para ACR. A imagem foi construída localmente."
            echo "##vso[task.setvariable variable=ACR_LOGIN_SUCCESS;isOutput=true]false"
            exit 0
          fi
      env:
        ACR_PASSWORD: $(acrPassword)
    
    # Docker: Tag for ACR (sempre executa, mas verifica se pode fazer)
    - task: Bash@3
      displayName: 'Docker: Tag Images for ACR'
      continueOnError: true
      inputs:
        targetType: 'inline'
        script: |
          echo "Verificando se pode fazer tag para ACR..."
          
          if [ -z "$(acrLoginServer)" ] || [ -z "$(acrPassword)" ]; then
            echo "=========================================="
            echo "ACR não configurado - Pulando tag"
            echo "=========================================="
            echo "Para habilitar:"
            echo "1. Crie o ACR no Azure (use script-infra-provision.sh)"
            echo "2. Configure a variável 'acrPassword' no Azure DevOps"
            echo "=========================================="
            exit 0
          fi
          
          echo "Tagging images for ACR..."
          docker tag $(imageName):$(imageTag) $(acrLoginServer)/$(imageName):$(imageTag)
          docker tag $(imageName):latest $(acrLoginServer)/$(imageName):latest
          echo "Images tagged successfully!"
    
    # Push to ACR (sempre executa, mas verifica se pode fazer)
    - task: Bash@3
      displayName: 'ACR: Push Images'
      continueOnError: true
      inputs:
        targetType: 'inline'
        script: |
          echo "Verificando se pode fazer push para ACR..."
          
          if [ -z "$(acrLoginServer)" ] || [ -z "$(acrPassword)" ]; then
            echo "=========================================="
            echo "ACR não configurado - Pulando push"
            echo "=========================================="
            echo "Para habilitar:"
            echo "1. Crie o ACR no Azure (use script-infra-provision.sh)"
            echo "2. Configure a variável 'acrPassword' no Azure DevOps"
            echo "=========================================="
            exit 0
          fi
          
          # Verificar se está logado
          if ! docker info | grep -q "$(acrLoginServer)"; then
            echo "Não está logado no ACR. Tentando login..."
            echo "$(acrPassword)" | docker login $(acrLoginServer) --username $(acrName) --password-stdin
          fi
          
          echo "Pushing images to ACR..."
          docker push $(acrLoginServer)/$(imageName):$(imageTag)
          docker push $(acrLoginServer)/$(imageName):latest
          echo ""
          echo "=========================================="
          echo "BUILD SUMMARY"
          echo "=========================================="
          echo "Image: $(acrLoginServer)/$(imageName):$(imageTag)"
          echo "Latest: $(acrLoginServer)/$(imageName):latest"
          echo "Build ID: $(Build.BuildId)"
          echo "=========================================="
    
    # Resumo do build (sempre executa)
    - task: Bash@3
      displayName: 'Build Summary'
      condition: always()
      inputs:
        targetType: 'inline'
        script: |
          echo ""
          echo "=========================================="
          echo "BUILD COMPLETED"
          echo "=========================================="
          echo "Image local: $(imageName):$(imageTag)"
          echo "Image local: $(imageName):latest"
          echo "Build ID: $(Build.BuildId)"
          if [ -n "$(acrLoginServer)" ] && [ -n "$(acrPassword)" ]; then
            echo "ACR configurado: $(acrLoginServer)"
            echo "Para ver status do push, verifique os steps anteriores"
          else
            echo "ACR: Não configurado ou não disponível"
            echo "Para configurar: Execute script-infra-provision.sh ou crie manualmente no Azure"
          fi
          echo "=========================================="

# =============================================================================
# STAGE 2: DEPLOY (CD)
# =============================================================================
- stage: Deploy
  displayName: 'Deploy to Azure Container Instances'
  dependsOn: Build
  condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/master')))
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy to ACI'
    pool:
      name: 'self-hosted-pool'
    # NOTA: Crie o ambiente 'production' em: Pipelines > Environments > New environment
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: 'Checkout Repository'
          
          - task: Bash@3
            displayName: 'Verificar/Instalar Azure CLI'
            inputs:
              targetType: 'inline'
              script: |
                if command -v az &> /dev/null; then
                  echo "Azure CLI já está instalado:"
                  az --version
                else
                  echo "Instalando Azure CLI..."
                  curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
                fi
          
          - task: AzureCLI@2
            displayName: 'Azure: Login'
            continueOnError: false
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Verificando Service Connection: $(azureServiceConnection)"
                echo "Logado no Azure"
                az account show
                if [ $? -ne 0 ]; then
                  echo "ERRO: Falha ao fazer login no Azure"
                  echo "Verifique se a Service Connection '$(azureServiceConnection)' está configurada corretamente"
                  exit 1
                fi
          
          - task: AzureCLI@2
            displayName: 'Verificar/Provisionar Infraestrutura'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Verificando recursos Azure..."
                
                # Verificar Resource Group
                if az group show --name $(azureRG) &> /dev/null; then
                  echo "Resource Group já existe: $(azureRG)"
                else
                  echo "Criando Resource Group..."
                  az group create --name $(azureRG) --location $(location)
                fi
                
                # Verificar ACR
                if az acr show --name $(acrName) --resource-group $(azureRG) &> /dev/null; then
                  echo "ACR já existe: $(acrName)"
                else
                  echo "Criando ACR..."
                  az acr create \
                    --resource-group $(azureRG) \
                    --name $(acrName) \
                    --sku Basic \
                    --admin-enabled true
                fi
                
                echo "Infraestrutura verificada/criada com sucesso!"
          
          - task: AzureCLI@2
            displayName: 'Deploy to ACI'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying to Azure Container Instances..."
                
                # Nome do container group
                ACI_GROUP_NAME="ecotask-api-$(Build.BuildId)"
                
                # Verificar se container já existe e deletar se necessário
                if az container show --resource-group $(azureRG) --name $ACI_GROUP_NAME &> /dev/null; then
                  echo "Container já existe. Deletando versão anterior..."
                  az container delete --resource-group $(azureRG) --name $ACI_GROUP_NAME --yes
                fi
                
                # Criar novo container instance
                az container create \
                  --resource-group $(azureRG) \
                  --name $ACI_GROUP_NAME \
                  --image $(acrLoginServer)/$(imageName):$(imageTag) \
                  --registry-login-server $(acrLoginServer) \
                  --registry-username $(acrName) \
                  --registry-password "$(acrPassword)" \
                  --dns-name-label ecotask-rm556221-$(Build.BuildId) \
                  --ports 8080 \
                  --environment-variables \
                    SPRING_DATASOURCE_URL="jdbc:postgresql://$(dbHost):$(dbPort)/$(dbName)" \
                    SPRING_DATASOURCE_USERNAME="$(dbUser)" \
                    SPRING_DATASOURCE_PASSWORD="$(dbPassword)" \
                    SPRING_RABBITMQ_HOST="$(rabbitmqHost)" \
                    SPRING_RABBITMQ_PORT="5672" \
                    SPRING_RABBITMQ_USERNAME="$(rabbitmqUser)" \
                    SPRING_RABBITMQ_PASSWORD="$(rabbitmqPassword)" \
                  --cpu 1 \
                  --memory 1.5 \
                  --restart-policy Always
                
                if [ $? -eq 0 ]; then
                  echo ""
                  echo "=========================================="
                  echo "DEPLOY REALIZADO COM SUCESSO!"
                  echo "=========================================="
                  
                  # Obter informações do container
                  FQDN=$(az container show --resource-group $(azureRG) --name $ACI_GROUP_NAME --query ipAddress.fqdn -o tsv)
                  IP=$(az container show --resource-group $(azureRG) --name $ACI_GROUP_NAME --query ipAddress.ip -o tsv)
                  
                  echo "Container Group: $ACI_GROUP_NAME"
                  echo "FQDN: $FQDN"
                  echo "IP: $IP"
                  echo "URL: http://$FQDN:8080"
                  echo "Build ID: $(Build.BuildId)"
                  echo ""
                  echo "A aplicação está rodando e disponível!"
                  echo "=========================================="
                else
                  echo "ERRO: Falha no deploy!"
                  exit 1
                fi

